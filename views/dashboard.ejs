<div class="dashboard-content">
  <!-- Messages -->
  <% if (typeof success !== 'undefined' && success) { %>
  <div class="message success">
    <i class="message-icon">‚úì</i>
    <%= success %>
  </div>
  <% } %> <% if (typeof error !== 'undefined' && error) { %>
  <div class="message error">
    <i class="message-icon">‚úó</i>
    <%= error %>
  </div>
  <% } %>

  <!-- Header -->
  <div class="dashboard-header">
    <h1 class="dashboard-title">Welcome to Odin Drive</h1>
    <p class="dashboard-subtitle">
      Hello, <span class="user-email"><%= user.email %></span>
    </p>
    <p class="dashboard-description">Your secure cloud storage solution</p>
  </div>

  <!-- Upload Section -->
  <div class="upload-section">
    <h2 class="section-title">Upload File</h2>
    <form
      action="/upload"
      method="POST"
      enctype="multipart/form-data"
      class="upload-form"
      onsubmit="return validateFileSize(this)"
    >
      <div class="file-input-wrapper">
        <input
          type="file"
          name="file"
          id="fileInput"
          class="file-input"
          required
          onchange="handleFileSelect(this)"
        />
        <label for="fileInput" class="file-input-label">
          <div class="upload-placeholder" id="uploadPlaceholder">
            <i class="upload-icon">üìÅ</i>
            <div class="upload-text">
              <h3>Drop your file here</h3>
              <p>or click to browse</p>
            </div>
          </div>
          <div class="file-preview" id="filePreview" style="display: none">
            <div class="preview-content">
              <i class="preview-icon" id="previewIcon">üìÅ</i>
              <div class="preview-info">
                <h4 id="fileName"></h4>
                <p id="fileSize"></p>
              </div>
            </div>
          </div>
        </label>
      </div>
      <div id="fileMessage" class="file-message"></div>
      <button type="submit" class="dashboard-button upload-button">
        <i class="button-icon">‚Üë</i>
        Upload File
      </button>
    </form>
  </div>

  <!-- Files Section -->
  <div class="files-section">
    <div class="section-header">
      <h2 class="section-title">Your Files</h2>
      <span class="file-count"
        ><%= files.length %> file<%= files.length !== 1 ? 's' : '' %></span
      >
    </div>

    <% if (files.length > 0) { %>
    <div class="files-list">
      <% files.forEach(file => { %>
      <div class="file-item">
        <div class="file-icon"><%- getFileIcon(file.mimetype) %></div>
        <div class="file-details">
          <h3 class="file-name"><%= file.originalName %></h3>
          <div class="file-meta">
            <span class="file-size"><%= formatFileSize(file.size) %></span>
            <span class="file-date"
              >Uploaded <%= new Date(file.createdAt).toLocaleDateString()
              %></span
            >
          </div>
        </div>
        <div class="file-actions">
          <a
            href="/download/<%= file.id %>"
            class="file-action download"
            title="Download"
          >
            <i class="action-icon">‚Üì</i>
          </a>
          <form
            action="/delete/<%= file.id %>"
            method="POST"
            class="delete-form"
          >
            <button
              type="submit"
              class="file-action delete"
              title="Delete"
              onclick="return confirm('Delete this file?')"
            >
              <i class="action-icon">√ó</i>
            </button>
          </form>
        </div>
      </div>
      <% }); %>
    </div>
    <% } else { %>
    <div class="empty-state">
      <div class="empty-icon">üìÅ</div>
      <h3>No files yet</h3>
      <p>Upload your first file to get started</p>
    </div>
    <% } %>
  </div>
</div>

<script>
  function handleFileSelect(input) {
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");
    const filePreview = document.getElementById("filePreview");
    const fileName = document.getElementById("fileName");
    const fileSize = document.getElementById("fileSize");
    const fileMessage = document.getElementById("fileMessage");

    const maxSizeMB = 100;
    const maxSizeBytes = maxSizeMB * 1024 * 1024;

    if (input.files.length > 0) {
      const file = input.files[0];
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);

      uploadPlaceholder.style.display = "none";
      filePreview.style.display = "block";
      fileName.textContent = file.name;
      fileSize.textContent = `${fileSizeMB}MB`;

      if (file.size > maxSizeBytes) {
        fileMessage.innerHTML = `<div class="message error">
        <i class="message-icon">‚úó</i>
        File too large: ${fileSizeMB}MB > ${maxSizeMB}MB max
      </div>`;
      } else {
        fileMessage.innerHTML = `<div class="message success">
        <i class="message-icon">‚úì</i>
        Ready to upload: ${fileSizeMB}MB / ${maxSizeMB}MB
      </div>`;
      }
    } else {
      removeSelectedFile();
    }
  }

  function removeSelectedFile() {
    const fileInput = document.getElementById("fileInput");
    const uploadPlaceholder = document.getElementById("uploadPlaceholder");
    const filePreview = document.getElementById("filePreview");
    const fileMessage = document.getElementById("fileMessage");

    fileInput.value = "";
    uploadPlaceholder.style.display = "block";
    filePreview.style.display = "none";
    fileMessage.innerHTML = "";
    event.stopPropagation();
  }

  function validateFileSize(form) {
    const fileInput = form.querySelector('input[type="file"]');
    const maxSize = 100 * 1024 * 1024;

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(1);

      if (file.size > maxSize) {
        alert(
          `‚ùå File too large!\n\nYour file: ${fileSizeMB}MB\nMaximum allowed: 100MB`
        );
        return false;
      }
    }
    return true;
  }

  // Drag and drop
  document.addEventListener("DOMContentLoaded", function () {
    const fileInput = document.getElementById("fileInput");
    const fileInputLabel = document.querySelector(".file-input-label");

    fileInputLabel.addEventListener("dragover", (e) => {
      e.preventDefault();
      fileInputLabel.classList.add("dragover");
    });

    fileInputLabel.addEventListener("dragleave", () => {
      fileInputLabel.classList.remove("dragover");
    });

    fileInputLabel.addEventListener("drop", (e) => {
      e.preventDefault();
      fileInputLabel.classList.remove("dragover");
      fileInput.files = e.dataTransfer.files;
      handleFileSelect(fileInput);
    });
  });
</script>
